---
title: "p8105_hw6_al4225"
author: "Anjing"
date: "2022-11-30"
output: github_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(broom)
library(dplyr)
library(modelr)
knitr::opts_chunk$set(
  fig.width = 7,
  fig.asp = .6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```


## Problem 2
### Raw data
```{r}
homicide_data = read_csv("./data/homicide-data.csv",
                col_names = TRUE) %>%
  janitor::clean_names() 
homicide_data
```

### Clean and tidy
Create a city_state variable (e.g. “Baltimore, MD”), and a binary variable indicating whether the homicide is solved. Omit cities Dallas, TX; Phoenix, AZ; and Kansas City, MO – these don’t report victim race. Also omit Tulsa, AL – this is a data entry mistake. For this problem, limit your analysis those for whom victim_race is white or black. Be sure that victim_age is numeric.
```{r}
homicide = 
  homicide_data %>%
  mutate(
    city_state = str_c(city, ", ", state)) %>%
  mutate(disposition_situation = ifelse(disposition %in% c("Closed without arrest", "Open/No arrest"), "unsolved", "solved"),
         #disposition_situation = as.factor(disposition_situation)
         ) %>%

  filter(!city_state %in% c("Dallas, TX", "Phoenix, AZ", "Kansas City, MO", "Tulsa, AL"), 
         victim_race %in% c("White", "Black")) %>%
  mutate(victim_age = as.numeric(victim_age))
homicide
```

### Logistic regression for Baltimore, MD
For the city of Baltimore, MD, use the glm function to fit a logistic regression with resolved vs unresolved as the outcome and victim age, sex and race as predictors. 
```{r}
Baltimore = 
homicide %>%
  filter(city_state == "Baltimore, MD") %>%
  mutate(
    disposition_situation = ifelse(disposition_situation == "solved", 1, 0),
    victim_race = fct_relevel(victim_race, "White")) %>% 
  select(disposition_situation, victim_age, victim_race, victim_sex)

glm = glm(Baltimore$disposition_situation ~ Baltimore$victim_age + Baltimore$victim_race + Baltimore$victim_sex, 
          family = binomial(link = "logit"))

summary(glm)

```

### Odds ratio
Apply the broom::tidy to this object; and obtain the estimate and confidence interval of the adjusted odds ratio for solving homicides comparing male victims to female victims keeping all other variables fixed.   

**Discription**: For male and female victims, OR = 0.426 < 1 and is included in the confidence interval. Sex and solving homicides are negative related which means men(1) victims tend to have unsolved homicides. The OR of men victims whose homicides were solved is 0.426 times than women victims. So homicides in which the victim is male are significantly less like to be resolved than those in which the victim is female.
```{r}
glm %>%
  broom::tidy()

glm %>%
  broom::tidy() %>%
  mutate(OR = exp(estimate),
         conf.low = exp(estimate - 1.96 * std.error),
         conf.high = exp(estimate + 1.96 * std.error)) %>%
  select(term, log_OR = estimate, OR, p.value, conf.low, conf.high) %>% 
  knitr::kable(digits = 3)

#confidence interval of OR--all include estimated value
exp(confint(glm))
```

### Save result as .RData
Save the output of glm as an R object;
```{r}
save(glm, file = "test/glm_baltimore_result.RData")
```